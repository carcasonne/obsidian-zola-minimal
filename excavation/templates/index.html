{% extends "base.html" %}

{% block content %}
{% set all_sections = get_section(path="_index.md") %}
{% set all_pages = [] %}
{% for section_path in all_sections.subsections %}
    {% set section = get_section(path=section_path) %}
    {% set_global all_pages = all_pages | concat(with=section.pages) %}
{% endfor %}

<div class="document-timeline">
    {% for page in all_pages | sort(attribute="updated") | reverse %}
    <article class="document-entry">
        <div class="doc-meta">
            <span class="doc-id">DOCUMENT <a href="{{ page.permalink }}">{{ page.title | lower }}</a></span>
            <time datetime="{{ page.date }}">catalogued {{ page.date | date(format="%d.%b.%Y") | lower }}</time>
        </div>
        
        <p class="doc-fragment">
            {{ page.content | striptags | truncate(length=360) }}
        </p>
        
        <div class="doc-filing">
            filed: {{ page.components | first | default(value="uncategorized") }} 
            • {{ page.word_count }}w approx.
            {% if page.updated != page.date %}
            • amended {{ page.updated | date(format="%d.%b") }}
            {% endif %}
        </div>

        {# MARGINALIA BASED ON SECTION #}
        {% set section_type = page.components | first %}

        {% if section_type == "reviews" %}
            {% if "book" in page.extra.tags %}
                <span class="margin-note-left rotate-2deg" style="top: 15%">lit.</span>
            {% endif %}
            {% if page.extra.rating %}
                <span class="margin-note-right" style="top: 25%">
                    {{ page.extra.rating | lower }}
                </span>
            {% endif %}
        {% endif %}

        {% if section_type == "articles" %}
            <span class="margin-note-left" style="top: 15%">thoughts</span>
            {% if page.extra.theme %}
                <span class="margin-note-right" style="top: 25%">
                    {{ page.extra.theme | lower }}
                </span>
            {% endif %}
        {% endif %}

        {# PAGE NUMBER #}
        <span class="page-num">{{ 73 + loop.index0 }}</span>
    </article>
    {% endfor %}
</div>

<div class="timeline-end">
    <p>— {{ all_pages | length }} documents recovered —</p>
</div>
{% endblock content %}